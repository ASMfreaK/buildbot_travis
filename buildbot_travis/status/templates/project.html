{% extends "layout.html" %}

{% macro display_builds(b, span, alt) -%}
    {% if b.builds %}
      {% for sb in b.builds %}
        <td class="DevStatus DevStatusBox {{ alt }}">
          <a href="#" title="" class="DevStatusBox {{ sb.color }}" target="_blank" onclick='showBuildBox("{{ sb.url }}", event); return false;'></a>
        </td>
      {% endfor %}
    {% else %}
      <td class="DevStatus DevStatusBox {{ alt }}" width="100%" colspan="{{ span }}">
        <a href="#" title="" class="DevStatusBox {{ b.color }}" target="_blank" onclick='showBuildBox("{{ b.url }}", event); return false;'></a>
      </td>
    {% endif %}
{%- endmacro %}

{% block head %}
  {{ super() }}
<script type='text/javascript'>
// <![CDATA[
//

//
// Functions used to display the build status bubble on box click.
//

// show the build status box. This is called when the user clicks on a block.
function showBuildBox(url, event) {
    // Find the current curson position.
    var cursorPosTop = (window.event ? window.event.clientY : event.pageY)
    var cursorPosLeft = (window.event ? window.event.clientX : event.pageX)

    // Offset the position by 5, to make the window appears under the cursor.
    cursorPosTop = cursorPosTop + document.body.scrollTop -5 ;
    cursorPosLeft = cursorPosLeft + document.body.scrollLeft - 5;

    // Move the div (hidden) under the cursor.
    var divBox = document.getElementById('divBox');
    divBox.style.top = parseInt(cursorPosTop) +
    divBox.style.left = parseInt(cursorPosLeft) + 'px';

    // Reload the hidden frame with the build page we want to show.
    // The onload even on this frame will update the div and make it visible.
    document.getElementById("frameBox").src = url
    
    // We don't want to reload the page.
    return false;
}

// OnLoad handler for the iframe containing the build to show.
function updateDiv(event) {
    // Get the frame innerHTML.
    var iframeContent = document.getElementById("frameBox").contentWindow.document.body.innerHTML;

    // If there is any content, update the div, and make it visible.
    if (iframeContent) {
        var divBox = document.getElementById('divBox');
        divBox.innerHTML = iframeContent ;
        divBox.style.display = "block";
    }
}

// Util functions to know if an element is contained inside another element.
// We use this to know when we mouse out our build status div.
function containsDOM (container, containee) {
    var isParent = false;
    do {
        if ((isParent = container == containee))
            break;
        containee = containee.parentNode;
    } while (containee != null);

    return isParent;
}

// OnMouseOut handler. Returns true if the mouse moved out of the element.
// It is false if the mouse is still in the element, but in a blank part of it,
// like in an empty table cell.
function checkMouseLeave(element, event) {
  if (element.contains && event.toElement) {
    return !element.contains(event.toElement);
  }
  else if (event.relatedTarget) {
    return !containsDOM(element, event.relatedTarget);
  }
}

// ]]>
</script>

{% endblock %}

{% block content %}

<h1>Project: {{ project }}</h1> 

<div align="center">
  <table width="95%" class="Grid" border="0" cellspacing="0">
    <tr>
      <td width="33%" align="left" class="left_align">
{#
{% if repository %}
        <br><b>Repository:</b> {{ repository|e }}
{% endif %}
{% if branch != ANYBRANCH %}
        <br><b>Branch:</b> {{ branch|e }}
{% endif %}
#}

      </td>
      <td width="33%" align="center" class="center_align">
        <div align="center">
          <table class="info">
            <tr>
              <td>Legend:&nbsp;&nbsp;</td>
              <td class='legend success' title='All tests passed'>Passed</td>
              <td class='legend failure' title='There is a new failure. Take a look!'>Failed</td>
              <td class='legend warnings' title='It was failing before, and it is still failing. Make sure you did not introduce new regressions'>Failed&nbsp;Again</td>
              <td class='legend running' title='The tests are still running'>Running</td>
              <td class='legend exception' title='Something went wrong with the test, there is no result'>Exception</td>
              <td class='legend offline' title='The builder is offline, as there are no slaves connected to it'>Offline</td>
              <td class='legend notstarted' title='No result yet.'>No&nbsp;data</td>
            </tr>
          </table>
        </div>
      </td>
     </tr>
  </table>
</div>

<br/>

{% set alt_class = cycler('', 'Alt') %}
{% set span = 10 %}

<table>

{% for e in environments %}
  <tr>
    <td class="DevStatus" colspan="2">{{ e.label }}</td>
    {% for n in e.children %}
    <td class="DevStatus" width="{{ n.width }}%" colspan="{{ n.span }}">{{ n.label }}</td>
    {% endfor %}
  </tr>
{% endfor %}

  <tr class='DevStatusSpacing'><td></td></tr>

{% for b in builds %}
  {% set alt = alt_class.next() %}

  {% if b.revisions %}
    {% for r in b.revisions %}
    <tr>
      <td width="1%" class="DevRev {{ alt }}">
      {{ r.revision|revlink(r.repository) }}
      </td>
      <td width="1%" class="DevName {{ alt }}">{{ r.who }}</td>
      {% if loop.first %}
      {{ display_builds(b, span, alt) }}
      {% else %}
      <td width="100%" class="DevStatus {{ alt }}" colspan="{{ span }}"></td>
      {% endif %}
    </tr>
    <tr>
      <td class="DevComment {{ alt }}" colspan="{{ span }}">{{ r.comments|replace('\n', '<br/>')|replace('  ','&nbsp; ') }}</td>
    </tr>
    {% endfor %}
  {% else %}
    <tr>
      <td width="1%" class="DevRev {{ alt }}">?</td>
      <td width="1%" class="DevName {{ alt }}">Anonymous</td>
      {{ display_builds(b, span, alt) }}
    </tr>
    <tr>
      <td class="DevComment {{ alt }}" colspan="{{ span }}">This build was forced through the web interface.</td>
    </tr>
  {% endif %}

  {% if b.failures %}
  <tr>
    <td class="DevDetails {{ alt }}" colspan="{{ span }}">
      <ul>
        {% for f in b.failures %}
        <li>
          <pre style="display: inline;">{% for k,v in f.env %}<b>{{ k }}</b> = {{ v }}; {% endfor %}</pre><br/>
          {{ f.name }}: <pre style="display: inline;">{{ f.firstline }}</pre><br/>
          {%- for l in f.logs -%}<a href="../{{ l.url }}">{{ l.name }}</a>&nbsp;{%- endfor -%}<br/><br/>
        </li>
        {% endfor %}
      </ul>
    </td>
  <tr>
  {% endif %}

  <tr class='DevStatusSpacing'><td></td></tr>
{% endfor %}
</table>

<div id="divBox" onmouseout="if (checkMouseLeave(this, event)) this.style.display = 'None'" class="BuildWaterfall">
</div>


<iframe id="frameBox" style="display: none;"></iframe>
  
<script type="text/javascript">
// replace 'onload="updateDiv(event);" with this, as iframe doesn't have onload event in xhtml
window.onload = function() {
  document.getElementById('frameBox').onload = function(event) {
    updateDiv(event);
  };
};
</script>

{% endblock %}

